@namespace DnsmasqWebUI.Components.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Models.Dnsmasq

@if (Status != null)
{
<div class="ec-sections small">
    @{
        var descriptors = EffectiveConfigFieldBuilder.BuildFieldDescriptors(Status);
        var sections = new[]
        {
            (EffectiveConfigFieldBuilder.SectionHosts, "Hosts"),
            (EffectiveConfigFieldBuilder.SectionResolver, "Resolver / DNS"),
            (EffectiveConfigFieldBuilder.SectionDnsRecords, "DNS records"),
            (EffectiveConfigFieldBuilder.SectionDhcp, "DHCP"),
            (EffectiveConfigFieldBuilder.SectionTftpPxe, "TFTP / PXE"),
            (EffectiveConfigFieldBuilder.SectionDnssec, "DNSSEC"),
            (EffectiveConfigFieldBuilder.SectionCache, "Cache"),
            (EffectiveConfigFieldBuilder.SectionProcess, "Process & networking")
        };
    }
    @foreach (var (sectionId, title) in sections)
    {
        var sectionDescriptors = descriptors.Where(d => d.SectionId == sectionId).ToList();
        if (sectionDescriptors.Count > 0)
        {
            <EffectiveConfigSectionPanel SectionId="@sectionId" Title="@title" Descriptors="@sectionDescriptors" IsOpen="@IsOpen(sectionId)" OnToggle="@OnSectionToggle" DisplayMode="@DisplayMode" />
        }
    }
</div>
}

@code {
    [Parameter] public DnsmasqServiceStatus? Status { get; set; }
    /// <summary>View = read-only; Edit = editable (future). Cascaded to field displays.</summary>
    [Parameter] public EffectiveConfigDisplayMode DisplayMode { get; set; } = EffectiveConfigDisplayMode.View;

    private HashSet<string> _openPanels = new();

    private bool IsOpen(string id) => _openPanels.Contains(id);

    private void OnSectionToggle(string id)
    {
        if (_openPanels.Contains(id))
            _openPanels.Remove(id);
        else
            _openPanels.Add(id);
    }
}
