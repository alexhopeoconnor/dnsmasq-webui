@namespace DnsmasqWebUI.Components.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Models.Dnsmasq
@using DnsmasqWebUI.Models.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Infrastructure.Helpers.Config
@inject IEffectiveConfigRenderFragmentRegistry RenderFragmentRegistry

<div class="ec-sections small">
    @{
        var views = EffectiveConfigViews.GetViewsForContext(Context);
        var descriptorsBySection = EffectiveConfigViews.GetDescriptorsBySection(Status, views, RenderFragmentRegistry);
        var hasSearch = !string.IsNullOrWhiteSpace(SearchTerm);
        var term = SearchTerm?.Trim() ?? "";
    }
    @foreach (var view in views)
    {
        if (!descriptorsBySection.TryGetValue(view.SectionId, out var contextDescriptors))
            continue;
        var sectionDescriptors = hasSearch
            ? contextDescriptors.Where(d => DescriptorMatchesSearch(d, term)).ToList()
            : contextDescriptors.ToList();
        if (sectionDescriptors.Count == 0)
            continue;
        var isOpen = hasSearch || IsSectionOpen(view.SectionId);
        <EffectiveConfigSectionPanel SectionId="@view.SectionId" Title="@view.Title" Descriptors="@sectionDescriptors" IsOpen="@isOpen" OnToggle="@OnSectionToggle"
            DisplayMode="@( IsEditMode ? EffectiveConfigDisplayMode.Edit : EffectiveConfigDisplayMode.View )"
            IsEditMode="@IsEditMode" ActiveFieldKey="@ActiveFieldKey" />
    }
</div>

@code {
    [Parameter] public DnsmasqServiceStatus? Status { get; set; }
    [Parameter] public EffectiveConfigContext Context { get; set; } = EffectiveConfigContext.All;
    [Parameter] public string SearchTerm { get; set; } = "";
    [Parameter] public HashSet<string> OpenSectionIds { get; set; } = new();
    [Parameter] public EventCallback<string> OnSectionToggle { get; set; }
    [Parameter] public bool IsEditMode { get; set; }
    [Parameter] public string? ActiveFieldKey { get; set; }

    private bool IsSectionOpen(string id) => OpenSectionIds.Contains(id);

    private static bool DescriptorMatchesSearch(EffectiveConfigFieldDescriptor d, string term)
    {
        if (string.IsNullOrEmpty(term)) return true;
        var searchable = (d.OptionName + " " + (DnsmasqOptionTooltips.Get(d.OptionName) ?? "")).Trim();
        return searchable.Contains(term, StringComparison.OrdinalIgnoreCase);
    }
}
