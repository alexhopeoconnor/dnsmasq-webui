@namespace DnsmasqWebUI.Components.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Models.Dnsmasq.EffectiveConfig

<ConfigOptionHelpModal HelpKey="@HelpKey" AnchorId="@AnchorId" Visible="@Visible" Title="@Title"
    OnClose="RequestClose" OnMouseEnterModal="CancelCloseTimer" OnMouseLeaveModal="ScheduleClose" />

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public string? HelpKey { get; set; }
    [Parameter] public string? AnchorId { get; set; }
    [Parameter] public string Title { get; set; } = "Option help";
    [Parameter] public EventCallback OnCloseRequested { get; set; }

    private CancellationTokenSource? _closeCts;

    private void CancelCloseTimer()
    {
        _closeCts?.Cancel();
        _closeCts = null;
    }

    private void ScheduleClose()
    {
        _closeCts?.Cancel();
        _closeCts = new CancellationTokenSource();
        var token = _closeCts.Token;
        _ = Task.Run(async () =>
        {
            try { await Task.Delay(300, token); }
            catch (OperationCanceledException) { return; }
            await InvokeAsync(async () =>
            {
                if (token.IsCancellationRequested) return;
                _closeCts = null;
                await OnCloseRequested.InvokeAsync();
            });
        }, token);
    }

    private async Task RequestClose()
    {
        CancelCloseTimer();
        await OnCloseRequested.InvokeAsync();
    }

    /// <summary>Called by the section when the label loses mouse (so we schedule close; if user moves to modal, OnMouseEnterModal cancels).</summary>
    public void ScheduleCloseFromLabelLeave()
    {
        ScheduleClose();
    }

    /// <summary>Called when opening or switching help (e.g. user clicked another label); cancels any pending 300ms close so the timer from a previous label leave does not dismiss the new help.</summary>
    public void CancelCloseFromLabelEnter()
    {
        CancelCloseTimer();
    }
}
