@namespace DnsmasqWebUI.Components.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Models.Dnsmasq
@using DnsmasqWebUI.Models.Dnsmasq.EffectiveConfig

<li class="ec-field" title="@(Source?.GetReadOnlyTooltip())">
    <span id="@OptionHelpAnchorId" class="ec-field-label @(OptionHelpKey != null ? "ec-field-label-help" : null)" title="@(LabelTooltip ?? Source?.GetReadOnlyTooltip())" @onclick="RaiseOptionHelpRequested" @onmouseleave="RaiseLabelMouseLeave"><strong>@Label:</strong></span>
    @if (DisplayMode == EffectiveConfigDisplayMode.Edit && Source?.IsReadOnly != true)
    {
        <span class="ec-field-value">
            <input type="text" class="form-control form-control-sm" value="@DisplayValue" @oninput="OnValueInput" />
        </span>
    }
    else
    {
        <span class="ec-field-value">
            @DisplayValue
            @if (Source?.IsReadOnly == true)
            {
                <span class="badge bg-secondary ec-badge-inline">readonly</span>
            }
        </span>
    }
</li>

@code {
    [Parameter] public string Label { get; set; } = "";
    [Parameter] public string DisplayValue { get; set; } = "";
    [Parameter] public ConfigValueSource? Source { get; set; }
    /// <summary>Optional explainer shown on hover over the label (e.g. from DnsmasqOptionTooltips).</summary>
    [Parameter] public string? LabelTooltip { get; set; }
    [Parameter] public string? OptionHelpKey { get; set; }
    [Parameter] public string? OptionHelpAnchorId { get; set; }
    /// <summary>When Edit and not readonly: raised when the user changes the value. Not yet wired to save.</summary>
    [Parameter] public EventCallback<string> DisplayValueChanged { get; set; }
    [CascadingParameter] public EffectiveConfigDisplayMode DisplayMode { get; set; } = EffectiveConfigDisplayMode.View;
    [Parameter] public EventCallback<ConfigOptionHelpRequestEventArgs> OnOptionHelpRequested { get; set; }

    private async Task RaiseOptionHelpRequested()
    {
        if (string.IsNullOrEmpty(OptionHelpKey) || string.IsNullOrEmpty(OptionHelpAnchorId)) return;
        await OnOptionHelpRequested.InvokeAsync(new ConfigOptionHelpRequestEventArgs { HelpKey = OptionHelpKey, OptionLabel = Label, AnchorId = OptionHelpAnchorId });
    }

    private async Task RaiseLabelMouseLeave()
    {
        if (string.IsNullOrEmpty(OptionHelpAnchorId)) return;
        await OnOptionHelpRequested.InvokeAsync(new ConfigOptionHelpRequestEventArgs { AnchorId = OptionHelpAnchorId, IsLabelMouseLeave = true });
    }

    private async Task OnValueInput(ChangeEventArgs e)
    {
        var value = e.Value?.ToString() ?? "";
        await DisplayValueChanged.InvokeAsync(value);
    }
}
