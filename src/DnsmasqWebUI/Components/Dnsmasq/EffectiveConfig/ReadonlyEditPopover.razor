@namespace DnsmasqWebUI.Components.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Models.Dnsmasq.EffectiveConfig
@using DnsmasqWebUI.Infrastructure.Helpers.Config
@using DnsmasqWebUI.Extensions
@using Microsoft.AspNetCore.Components
@using Microsoft.JSInterop
@using System.Text.Json.Serialization
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

@if (Visible && Source != null)
{
    <div class="ec-readonly-popover" id="@_popoverId" style="@_positionStyle" @onmouseenter="OnPopoverMouseEnter" @onmouseleave="OnPopoverMouseLeave">
        <div class="ec-readonly-popover-content">
            <div class="ec-readonly-popover-header">
                <span class="ec-readonly-popover-title">Read-only: @OptionName</span>
            </div>
            <div class="ec-readonly-popover-body small">
                <p class="text-muted mb-2">@ReadonlyConfigCommandGenerator.GetEditFileHint(Source)</p>
                @if (!string.IsNullOrEmpty(_removeCommand))
                {
                    <div class="mb-2">
                        <CopyableCodeLine Text="@_removeCommand" CodeCssClass="small" CopyTitle="Copy command" />
                    </div>
                }
                @if (!string.IsNullOrEmpty(_overrideLine))
                {
                    <p class="text-muted mb-1">@ReadonlyConfigCommandGenerator.GetOverrideHint(OptionName, Value, ManagedFilePath)</p>
                    <CopyableCodeLine Text="@_overrideLine" CodeCssClass="small" CopyTitle="Copy line" />
                }
            </div>
        </div>
    </div>
}

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public string? AnchorId { get; set; }
    [Parameter] public ConfigValueSource? Source { get; set; }
    [Parameter] public string OptionName { get; set; } = "";
    [Parameter] public object? Value { get; set; }
    [Parameter] public string? ManagedFilePath { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }
    [Parameter] public EventCallback OnMouseEnterPopover { get; set; }
    [Parameter] public EventCallback OnMouseLeavePopover { get; set; }

    private const string HiddenPositionStyle = "position: fixed; z-index: 1060; left: 0; top: 0; visibility: hidden;";
    private const string VisiblePositionStyleFormat = "position: fixed; top: {0}px; left: {1}px; visibility: visible;";

    private string _positionStyle = "";
    private readonly string _popoverId = "ec-readonly-popover-" + Guid.NewGuid().ToString("N")[..8];
    private DotNetObjectReference<ReadonlyEditPopover>? _dotNetRef;
    private bool _scrollListenerAdded;
    private bool _mouseOverPopover;
    private IJSObjectReference? _jsModule;
    private bool _moduleLoaded;
    private string _removeCommand = "";
    private string _overrideLine = "";

    protected override void OnParametersSet()
    {
        if (Source is { IsReadOnly: true })
        {
            _removeCommand = ReadonlyConfigCommandGenerator.GetRemoveLineCommand(Source, OptionName);
            _overrideLine = ReadonlyConfigCommandGenerator.GetOverrideLine(OptionName, Value, ManagedFilePath);
        }
        else
        {
            _removeCommand = "";
            _overrideLine = "";
        }
        if (Visible && string.IsNullOrEmpty(_positionStyle))
            _positionStyle = HiddenPositionStyle;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                _jsModule = await JSRuntime.InvokeAsync<IJSObjectReference>("import", "./js/config-option-help.js");
                _moduleLoaded = true;
            }
            catch (InvalidOperationException) { }
            catch (JSDisconnectedException) { }
            catch (JSException) { }
        }

        if (Visible && !_scrollListenerAdded && _moduleLoaded && _jsModule != null)
        {
            _scrollListenerAdded = true;
            _dotNetRef = DotNetObjectReference.Create(this);
            await _jsModule.InvokeVoidAsyncSafe("addScrollCloseListener", _dotNetRef);
        }
        else if (!Visible && _scrollListenerAdded && _jsModule != null)
        {
            _scrollListenerAdded = false;
            await _jsModule.InvokeVoidAsyncSafe("removeScrollCloseListener");
            _dotNetRef?.Dispose();
            _dotNetRef = null;
        }

        if (!Visible)
            _positionStyle = "";

        if (Visible && _moduleLoaded && _jsModule != null)
        {
            await PositionUnderAnchorAsync();
            StateHasChanged();
        }
    }

    [JSInvokable]
    public async Task OnScrollClose()
    {
        await PositionUnderAnchorAsync();
        StateHasChanged();
        if (!_mouseOverPopover)
            await OnClose.InvokeAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (_scrollListenerAdded && _jsModule != null)
        {
            _scrollListenerAdded = false;
            await _jsModule.InvokeVoidAsyncSafe("removeScrollCloseListener");
            _dotNetRef?.Dispose();
            _dotNetRef = null;
        }
        await _jsModule.DisposeAsyncSafe();
        _jsModule = null;
    }

    private async Task PositionUnderAnchorAsync()
    {
        if (string.IsNullOrEmpty(AnchorId) || _jsModule == null) return;
        var rect = await _jsModule.InvokeAsyncSafe<BoundingRect?>("getAnchorRect", AnchorId);
        if (rect is { } r)
        {
            var gap = 4;
            var topPx = r.Bottom + gap;
            var leftPx = r.Left;
            _positionStyle = string.Format(VisiblePositionStyleFormat, topPx, leftPx);
        }
        else
        {
            _positionStyle = HiddenPositionStyle;
        }
    }

    private async Task OnPopoverMouseEnter()
    {
        _mouseOverPopover = true;
        await OnMouseEnterPopover.InvokeAsync();
    }

    private async Task OnPopoverMouseLeave()
    {
        _mouseOverPopover = false;
        await OnMouseLeavePopover.InvokeAsync();
    }

    private sealed record BoundingRect(
        [property: JsonPropertyName("top")] double Top,
        [property: JsonPropertyName("left")] double Left,
        [property: JsonPropertyName("bottom")] double Bottom,
        [property: JsonPropertyName("width")] double Width,
        [property: JsonPropertyName("height")] double Height);
}
