@namespace DnsmasqWebUI.Components.EffectiveConfig
@using DnsmasqWebUI.Models.Dnsmasq
@using DnsmasqWebUI.Models.Dnsmasq.EffectiveConfig

<ReadonlyEditPopover Visible="@Visible" AnchorId="@AnchorId" Source="@Source" OptionName="@OptionName" Value="@Value" ManagedFilePath="@ManagedFilePath"
    OnClose="RequestClose" OnMouseEnterPopover="CancelCloseTimer" OnMouseLeavePopover="ScheduleClose" />

@code {
    [Parameter] public bool Visible { get; set; }
    [Parameter] public string? AnchorId { get; set; }
    [Parameter] public ConfigValueSource? Source { get; set; }
    [Parameter] public string OptionName { get; set; } = "";
    [Parameter] public object? Value { get; set; }
    [Parameter] public string? ManagedFilePath { get; set; }
    [Parameter] public EventCallback OnCloseRequested { get; set; }

    private CancellationTokenSource? _closeCts;

    private void CancelCloseTimer()
    {
        _closeCts?.Cancel();
        _closeCts = null;
    }

    private void ScheduleClose()
    {
        _closeCts?.Cancel();
        _closeCts = new CancellationTokenSource();
        var token = _closeCts.Token;
        _ = Task.Run(async () =>
        {
            try { await Task.Delay(300, token); }
            catch (OperationCanceledException) { return; }
            await InvokeAsync(async () =>
            {
                if (token.IsCancellationRequested) return;
                _closeCts = null;
                await OnCloseRequested.InvokeAsync();
            });
        }, token);
    }

    private async Task RequestClose()
    {
        CancelCloseTimer();
        await OnCloseRequested.InvokeAsync();
    }

    /// <summary>
    /// Called when mouse leaves readonly badge; close unless pointer enters popover quickly.
    /// </summary>
    public void ScheduleCloseFromBadgeLeave()
    {
        ScheduleClose();
    }

    /// <summary>
    /// Called when readonly badge is interacted with to keep popover open.
    /// </summary>
    public void CancelCloseFromBadgeEnter()
    {
        CancelCloseTimer();
    }
}
