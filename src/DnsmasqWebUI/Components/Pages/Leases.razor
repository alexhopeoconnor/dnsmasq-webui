@page "/leases"
@rendermode InteractiveServer
@inject HttpClient Http

<PageTitle>DHCP Leases</PageTitle>

<h1>DHCP Leases</h1>

@if (_status == null)
{
    <p>Loading...</p>
}
else if (!_status.leasesPathConfigured)
{
    <p class="text-warning">Leases not configured.</p>
}
else
{
    @if (_error != null)
    {
        <div class="alert alert-danger">@_error</div>
    }
    @if (!_status.leasesPathExists)
    {
        <p class="text-warning">Leases file not found: @_status.leasesPath. DHCP may be disabled or path may be wrong.</p>
    }
    else if (_leases == null)
    {
        <p class="text-warning">Could not read leases file.</p>
    }
    else
    {
        <table class="table table-bordered">
            <thead>
                <tr><th>Expiry</th><th>MAC</th><th>Address</th><th>Name</th><th>Client ID</th></tr>
            </thead>
            <tbody>
                @foreach (var e in _leases)
                {
                    <tr>
                        <td>@e.timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                        <td>@e.mac</td>
                        <td>@e.address</td>
                        <td>@e.name</td>
                        <td>@e.clientId</td>
                    </tr>
                }
            </tbody>
        </table>
        <p class="text-muted small">Path: @_status.leasesPath (read-only). Data is read from disk on each request; use Refresh to refetch.</p>
        <button class="btn btn-outline-primary btn-sm mt-1" @onclick="LoadLeases" disabled="@_loading">Refresh</button>
    }
}

@code {
    private StatusDto? _status;
    private List<LeaseDto>? _leases;
    private string? _error;
    private bool _loading;

    private class StatusDto
    {
        public string? leasesPath { get; set; }
        public bool leasesPathConfigured { get; set; }
        public bool leasesPathExists { get; set; }
    }

    private class LeaseDto
    {
        public long epoch { get; set; }
        public string? mac { get; set; }
        public string? address { get; set; }
        public string? name { get; set; }
        public string? clientId { get; set; }
        public DateTime timestamp => DateTimeOffset.FromUnixTimeSeconds(epoch).DateTime;
    }

    private class LeasesResponse
    {
        public bool available { get; set; }
        public List<LeaseDto>? entries { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            _status = await Http.GetFromJsonAsync<StatusDto>("api/status");
            await LoadLeases();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task LoadLeases()
    {
        if (_status == null || !_status.leasesPathConfigured) return;
        _loading = true;
        _error = null;
        try
        {
            var resp = await Http.GetFromJsonAsync<LeasesResponse>("api/leases");
            if (resp?.entries != null)
                _leases = resp.entries;
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _loading = false;
        }
    }
}
