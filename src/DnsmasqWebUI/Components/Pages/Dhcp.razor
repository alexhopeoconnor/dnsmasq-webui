@page "/dhcp"
@page "/leases"
@rendermode InteractiveServer
@namespace DnsmasqWebUI.Components.Pages
@inject IStatusClient StatusClient
@inject IDhcpHostsClient DhcpHostsClient
@inject ILeasesClient LeasesClient
@inject IReloadClient ReloadClient

<PageTitle>DHCP</PageTitle>

<h1 class="mb-4">DHCP</h1>

@if (_status == null)
{
    <p>Loading...</p>
}
else
{
    @* ---- Static hosts (dhcp-host= in managed file) ---- *@
    <section class="mb-4">
        <h2 class="h5 mb-2">Static hosts</h2>
        @if (!_status.ManagedFilePathExists)
        {
            <p class="text-warning">Managed config file not found: @_status.ManagedFilePath</p>
        }
        else
        {
    @if (_status.DnsmasqStatus == "inactive" || _status.DnsmasqStatus == "unknown")
    {
        <div class="alert alert-warning">Dnsmasq service appears to be <strong>@_status.DnsmasqStatus</strong>. Save will update the file but reload may fail until the service is fixed.</div>
    }
    @if (_error != null)
    {
        <div class="alert alert-danger">@_error</div>
    }
    @if (_message != null)
    {
        <div class="alert alert-success">@_message</div>
    }
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>#</th><th>Valid</th><th>MAC</th><th>Name</th><th>Address</th><th>Lease</th><th>Ignore</th><th>Comment</th><th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var e in _entries.Where(x => !x.IsDeleted))
            {
                <tr class="@(e.IsComment ? "table-secondary" : "")" @key="e.Id">
                    <td>@e.LineNumber</td>
                    <td><input type="checkbox" checked="@(!e.IsComment)" @onchange="() => ToggleValid(e)" /></td>
                    <td><input class="form-control form-control-sm" value="@string.Join(", ", e.MacAddresses)" @oninput="ev => SetMac(e, ev.Value?.ToString())" style="min-width:140px" /></td>
                    <td><input class="form-control form-control-sm" @bind="e.Name" /></td>
                    <td><input class="form-control form-control-sm" @bind="e.Address" style="min-width:100px" /></td>
                    <td><input class="form-control form-control-sm" @bind="e.Lease" style="min-width:70px" /></td>
                    <td><input type="checkbox" checked="@e.Ignore" @onchange="() => ToggleIgnore(e)" /></td>
                    <td><input class="form-control form-control-sm" @bind="e.Comment" /></td>
                    <td><button class="btn btn-sm btn-danger" @onclick="() => Delete(e)">Delete</button></td>
                </tr>
            }
        </tbody>
    </table>
    <button class="btn btn-secondary mt-2" @onclick="Add">Add host</button>
    <button class="btn btn-primary mt-2" @onclick="Save" disabled="@_saving">Save</button>
    @if (_status.ReloadCommandConfigured)
    {
        <button class="btn btn-outline-primary mt-2" @onclick="Reload" disabled="@_saving">Reload dnsmasq</button>
    }
    <p class="text-muted small mt-2">Managed file: @_status.ManagedFilePath</p>
        }
    </section>

    @* ---- Leases (dhcp-leasefile, read-only) ---- *@
    <section class="mb-4">
        <h2 class="h5 mb-2">Leases</h2>
        @if (!_status.LeasesPathConfigured)
        {
            <p class="text-muted">Leases not configured (no dhcp-leasefile in config).</p>
        }
        else if (!_status.LeasesPathExists)
        {
            <p class="text-warning">Leases file not found: @_status.LeasesPath. DHCP may be disabled or path may be wrong.</p>
        }
        else if (_leases == null)
        {
            <p class="text-warning">Could not read leases file.</p>
        }
        else if (_leases.Count == 0)
        {
            <p class="text-muted">No leases yet. Leases appear here when DHCP clients obtain an address; use Refresh to update.</p>
            <p class="text-muted small">Path: @_status.LeasesPath</p>
            <button class="btn btn-outline-primary btn-sm mt-1" @onclick="LoadLeases" disabled="@_leasesLoading">Refresh</button>
        }
        else
        {
            <table class="table table-bordered">
                <thead>
                    <tr><th>Expiry</th><th>MAC</th><th>Address</th><th>Name</th><th>Client ID</th></tr>
                </thead>
                <tbody>
                    @foreach (var e in _leases)
                    {
                        <tr>
                            <td>@e.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")</td>
                            <td>@e.Mac</td>
                            <td>@e.Address</td>
                            <td>@e.Name</td>
                            <td>@e.ClientId</td>
                        </tr>
                    }
                </tbody>
            </table>
            <p class="text-muted small">Path: @_status.LeasesPath (read-only). Cached and refreshed when the file changes.</p>
            <button class="btn btn-outline-primary btn-sm mt-1" @onclick="LoadLeases" disabled="@_leasesLoading">Refresh</button>
        }
    </section>
}

@code {
    private DnsmasqServiceStatus? _status;
    private List<DhcpHostEntry> _entries = new();
    private IReadOnlyList<LeaseEntry>? _leases;
    private bool _leasesLoading;
    private string? _error;
    private string? _message;
    private bool _saving;

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task Load()
    {
        _error = null;
        _message = null;
        try
        {
            _status = await StatusClient.GetStatusAsync();
            var entries = await DhcpHostsClient.GetDhcpHostsAsync();
            _entries = entries?.ToList() ?? new List<DhcpHostEntry>();
            await LoadLeases();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task LoadLeases()
    {
        if (_status == null || !_status.LeasesPathConfigured) return;
        _leasesLoading = true;
        try
        {
            var resp = await LeasesClient.GetLeasesAsync();
            _leases = resp.Entries;
        }
        finally
        {
            _leasesLoading = false;
        }
    }

    private void Add()
    {
        _entries.Add(new DhcpHostEntry { Id = "new:" + Guid.NewGuid().ToString("N"), LineNumber = 0, MacAddresses = new List<string>(), Extra = new List<string>() });
        StateHasChanged();
    }

    private void Delete(DhcpHostEntry e)
    {
        e.IsDeleted = true;
        StateHasChanged();
    }

    private void ToggleValid(DhcpHostEntry e)
    {
        e.IsComment = !e.IsComment;
        StateHasChanged();
    }

    private void ToggleIgnore(DhcpHostEntry e)
    {
        e.Ignore = !e.Ignore;
        StateHasChanged();
    }

    private void SetMac(DhcpHostEntry e, string? value)
    {
        e.MacAddresses = value?.Split(',').Select(s => s.Trim()).Where(s => s.Length > 0).ToList() ?? new List<string>();
        StateHasChanged();
    }

    private async Task Save()
    {
        _saving = true;
        _error = null;
        _message = null;
        try
        {
            var result = await DhcpHostsClient.SaveDhcpHostsAsync(_entries);
            if (result.Reload.Success)
                _message = "Saved and dnsmasq reloaded.";
            else if (!string.IsNullOrEmpty(result.Reload.StdErr))
                _error = "Saved but dnsmasq reload failed: " + result.Reload.StdErr;
            else
                _message = "Saved.";
            await Load();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task Reload()
    {
        _saving = true;
        _error = null;
        _message = null;
        try
        {
            var result = await ReloadClient.ReloadAsync();
            if (result.Success)
                _message = "Dnsmasq reloaded.";
            else
                _error = "Reload failed: " + (result.StdErr ?? "unknown");
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }
}
