@page "/hosts"
@rendermode InteractiveServer
@namespace DnsmasqWebUI.Components.Pages
@inject IStatusClient StatusClient
@inject IHostsClient HostsClient
@inject IOptions<ApplicationOptions> AppOptions
<PageTitle>Hosts | @AppTitle</PageTitle>

<h1 class="page-title">Hosts file</h1>

@if (_status == null)
{
    <p class="d-flex align-items-center gap-2">
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Loading...
    </p>
}
else
{
    <section class="page-section mb-4">
        <h2 class="page-section-title">Config affecting hosts</h2>
        <EffectiveConfigSection Status="_status" Context="EffectiveConfigContext.Hosts" ShowSearchBox="true" OnSaveCompleted="RefreshStatusAsync" />
    </section>
    @if (string.IsNullOrEmpty(_status.ManagedHostsFilePath))
    {
        <p class="text-muted">Hosts editing is unavailable: managed hosts path is not configured. Set <strong>Dnsmasq:MainConfigPath</strong> (and optionally <strong>Dnsmasq:ManagedHostsFileName</strong>) so the app can create and edit the managed hosts file.</p>
        @if (_status.AddnHostsPaths?.Count > 0)
        {
            <p class="text-muted small">Dnsmasq loads these addn-hosts files: @RenderAddnHostsList()</p>
        }
    }
    else
    {
        @if (_status.DnsmasqStatus == "inactive" || _status.DnsmasqStatus == "unknown")
        {
            <div class="alert alert-warning">Dnsmasq service appears to be <strong>@_status.DnsmasqStatus</strong>. Save will update the file but reload may fail until the service is fixed.</div>
        }
        @if (_error != null)
        {
            <div class="alert alert-danger">@_error</div>
        }
        @if (_message != null)
        {
            <div class="alert alert-success">@_message</div>
        }

        <HostsFileSection Path="@(_status.ManagedHostsFilePath ?? "")" Entries="_entries" IsEditable="true" IsFirst="true" />
        <button class="btn btn-primary mt-2" @onclick="Save" disabled="@_saving">Save</button>

        @if (_readOnlyHosts?.Count > 0)
        {
            @foreach (var ro in _readOnlyHosts)
            {
                <HostsFileSection Path="@ro.Path" Entries="@ro.Entries" IsEditable="false" IsFirst="false" @key="@ro.Path" />
            }
        }
    }
}

@code {
    private string AppTitle => AppOptions!.Value!.EffectiveTitle;
    private DnsmasqServiceStatus? _status;
    private List<HostEntry> _entries = new();
    private IReadOnlyList<ReadOnlyHostsFile>? _readOnlyHosts;
    private string? _error;
    private string? _message;
    private bool _saving;

    /// <summary>Returns MarkupString so Blazor renders raw HTML (path + source label).</summary>
    private MarkupString RenderAddnHostsList()
    {
        if (_status?.AddnHostsPaths == null || _status.AddnHostsPaths.Count == 0)
            return (MarkupString)"(none)";
        var srcList = _status.EffectiveConfigSources?.AddnHostsPaths;
        if (srcList != null && srcList.Count == _status.AddnHostsPaths.Count)
        {
            return (MarkupString)string.Join(", ", srcList.Select(e =>
            {
                var src = e.Source;
                var tip = src?.GetReadOnlyTooltip() ?? "";
                var label = src == null ? "?" : (src.IsReadOnly ? "from " + src.FileName + ", readonly" : "editable");
                return $"{System.Net.WebUtility.HtmlEncode(e.Path)} <span class=\"text-muted\" title=\"{System.Net.WebUtility.HtmlEncode(tip)}\">({System.Net.WebUtility.HtmlEncode(label)})</span>";
            }));
        }
        return (MarkupString)System.Net.WebUtility.HtmlEncode(string.Join(", ", _status.AddnHostsPaths));
    }

    protected override async Task OnInitializedAsync()
    {
        await Load();
    }

    private async Task RefreshStatusAsync()
    {
        try
        {
            _status = await StatusClient.GetStatusAsync();
            await InvokeAsync(StateHasChanged);
        }
        catch { /* ignore */ }
    }

    private async Task Load()
    {
        _error = null;
        _message = null;
        try
        {
            _status = await StatusClient.GetStatusAsync();
            var entries = await HostsClient.GetHostsAsync();
            _entries = entries?.ToList() ?? new List<HostEntry>();
            _readOnlyHosts = await HostsClient.GetReadOnlyHostsAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
    }

    private async Task Save()
    {
        _saving = true;
        _error = null;
        _message = null;
        try
        {
            var result = await HostsClient.SaveHostsAsync(_entries);
            if (result.Reload.Success)
                _message = "Saved and dnsmasq reloaded.";
            else if (!string.IsNullOrEmpty(result.Reload.StdErr))
                _error = "Saved but dnsmasq reload failed: " + result.Reload.StdErr;
            else
                _message = "Saved.";
            _status = await StatusClient.GetStatusAsync();
        }
        catch (Exception ex)
        {
            _error = ex.Message;
        }
        finally
        {
            _saving = false;
        }
    }
}
